<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Better Productive.io</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#6366f1">
  <style>
{{STYLES}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-top">
        <div class="header-brand">
          <img src="/logo.svg" alt="Logo">
          <h1>Better Productive.io</h1>
        </div>
        <div class="header-actions">
          <button id="themeToggle" class="icon-btn" title="Toggle theme">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v2"/><path d="M14.837 16.385a6 6 0 1 1-7.223-7.222c.624-.147.97.66.715 1.248a4 4 0 0 0 5.26 5.259c.589-.255 1.396.09 1.248.715"/><path d="M16 12a4 4 0 0 0-4-4"/><path d="m19 5-1.256 1.256"/><path d="M20 12h2"/>
            </svg>
          </button>
          {{LOGOUT_BUTTON}}
        </div>
      </div>
    </header>

    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" 
             placeholder="Search by ticket (PRIM-242), title, status..." autofocus>
    </div>

    <div class="filters" id="filtersContainer">
      <div class="filter-group">
        <span class="filter-label">Project:</span>
        <select class="filter-select" id="filterProject" style="min-width: 180px;">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <select class="filter-select" id="filterStatus">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Due:</span>
        <select class="filter-select" id="filterDue">
          <option value="">Any</option>
          <option value="overdue">Overdue</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
          <option value="none">No Due Date</option>
        </select>
      </div>
      <div class="filter-row-last">
        <label class="filter-checkbox">
          <input type="checkbox" id="filterMeOnly">
          <span>Assigned to me</span>
        </label>
        <button class="btn btn-clear" onclick="clearFilters()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px;"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg> Clear</button>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" id="syncBtn" onclick="updateNow()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/>
        </svg>
        Sync
      </button>
      <button class="btn btn-primary" id="copyAllBtn" onclick="copyAllAsMarkdown()" disabled title="Apply filters first"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>Copy List</button>
      <div class="sync-progress" id="syncProgress">
        <span id="syncProgressText">Syncing...</span>
        <div class="sync-progress-bar" id="syncProgressBar"></div>
      </div>
      <span class="stats" style="margin-left: auto;">{{STATS_TEXT}} â€¢ Synced: {{LAST_UPDATED}}</span>
    </div>

    <div id="resultCount" class="result-count"></div>
    <div id="results" class="results">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <script>
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const resultCountDiv = document.getElementById('resultCount');
    const filterProject = document.getElementById('filterProject');
    const filterStatus = document.getElementById('filterStatus');
    const filterDue = document.getElementById('filterDue');
    const filterMeOnly = document.getElementById('filterMeOnly');
    
    let allTasks = [];
    let filteredTasks = [];
    let currentPersonId = null;
    let debounceTimer;
    
    // Pagination
    let currentPage = 1;
    const pageSize = 50;

    // Load filters and initial data
    loadFilters();
    loadTasks();

    // Event listeners
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
      // Left/Right arrow for pagination
      if (document.activeElement !== searchInput) {
        if (e.key === 'ArrowLeft') changePage(-1);
        if (e.key === 'ArrowRight') changePage(1);
      }
    });

    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(applyFilters, 200);
    });

    filterProject.addEventListener('change', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    filterDue.addEventListener('change', applyFilters);
    filterMeOnly.addEventListener('change', applyFilters);

    async function loadFilters() {
      try {
        const res = await fetch('/api/filters');
        if (!res.ok) throw new Error('Failed to load filters');
        const data = await res.json();
        
        // Populate Projects
        data.projects.forEach(p => {
          const option = document.createElement('option');
          option.value = p.prefix;
          option.textContent = p.name + ' (' + p.prefix + ')';
          filterProject.appendChild(option);
        });
        
        // Populate Statuses
        data.statuses.forEach(s => {
          const option = document.createElement('option');
          option.value = s;
          option.textContent = s;
          filterStatus.appendChild(option);
        });
        
        // Store current person ID
        currentPersonId = data.currentPersonId;
        
      } catch (err) {
        console.error('Error loading filters:', err);
      }
    }

    async function loadTasks() {
      try {
        const res = await fetch('/api/search?q=');
        if (!res.ok) throw new Error('Failed to load tasks');
        const data = await res.json();
        allTasks = data.tasks;
        filteredTasks = allTasks;
        applyFilters();
      } catch (err) {
        resultsDiv.innerHTML = '<div class="error">Failed to load tasks</div>';
      }
    }

    function applyFilters() {
      const query = searchInput.value.toLowerCase().trim();
      const project = filterProject.value;
      const status = filterStatus.value;
      const due = filterDue.value;
      const meOnly = filterMeOnly.checked;

      // Date calculations for filters
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const tomorrow = today + 86400000;
      const nextWeek = today + (7 * 86400000);
      const nextMonth = today + (30 * 86400000);
      const nextYear = today + (365 * 86400000);

      filteredTasks = allTasks.filter(task => {
        // Text search
        if (query) {
          const searchText = (task.ticketKey + ' ' + task.title + ' ' + task.status + ' ' + task.assignee + ' ' + task.project).toLowerCase();
          if (!searchText.includes(query)) return false;
        }
        
        // Project filter
        if (project && task.projectPrefix !== project) return false;
        
        // Status filter
        if (status && task.status !== status) return false;
        
        // Assigned to me filter
        if (meOnly && task.assigneeId !== currentPersonId) return false;

        // Due date filter
        if (due) {
          if (due === 'none') return !task.dueDate;
          if (!task.dueDate) return false;
          
          const dueDate = new Date(task.dueDate).getTime();
          
          if (due === 'overdue') return dueDate < today;
          if (due === 'today') return dueDate >= today && dueDate < tomorrow;
          if (due === 'week') return dueDate >= today && dueDate < nextWeek;
          if (due === 'month') return dueDate >= today && dueDate < nextMonth;
          if (due === 'year') return dueDate >= today && dueDate < nextYear;
        }

        return true;
      });
      
      currentPage = 1;
      renderTasks();
      updateCopyButtonState();
    }
    
    function changePage(delta) {
      const maxPage = Math.ceil(filteredTasks.length / pageSize) || 1;
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= maxPage) {
        currentPage = newPage;
        renderTasks();
        resultsDiv.scrollTop = 0;
      }
    }

    function renderTasks() {
      if (filteredTasks.length === 0) {
        resultsDiv.innerHTML = '<div class="empty">No tasks found</div>';
        resultCountDiv.textContent = '0 results';
        return;
      }
      
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredTasks.length);
      const pageTasks = filteredTasks.slice(startIndex, endIndex);
      
      // Pagination controls
      const maxPage = Math.ceil(filteredTasks.length / pageSize);
      const paginationHtml = maxPage > 1 ? 
        '<div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">' +
          '<button class="btn btn-secondary" onclick="changePage(-1)" ' + (currentPage === 1 ? 'disabled' : '') + ' style="padding: 0.25rem 0.75rem;">Previous</button>' +
          '<span style="font-size: 0.9rem; color: var(--text-secondary);">Page ' + currentPage + ' of ' + maxPage + '</span>' +
          '<button class="btn btn-secondary" onclick="changePage(1)" ' + (currentPage === maxPage ? 'disabled' : '') + ' style="padding: 0.25rem 0.75rem;">Next</button>' +
        '</div>' : '';

      resultsDiv.innerHTML = pageTasks.map(renderTask).join('') + paginationHtml;
      resultCountDiv.textContent = filteredTasks.length + ' results' + (filteredTasks.length > pageSize ? ' (showing ' + (startIndex + 1) + '-' + endIndex + ')' : '');
    }

    function clearFilters() {
      searchInput.value = '';
      filterProject.value = '';
      filterStatus.value = '';
      filterDue.value = '';
      filterMeOnly.checked = false;
      applyFilters();
    }

    function renderTask(task) {
      const statusClass = getStatusClass(task.status);
      const created = task.createdAt ? formatDate(task.createdAt) : '';
      const updated = task.updatedAt ? formatDate(task.updatedAt) : '';
      
      return `
        <div class="task-card">
          <div class="task-header">
            <span class="ticket-key">
              <a href="/browse/${task.ticketKey}" title="Open in Productive">${task.ticketKey}</a>
            </span>
            <div class="task-title">
              <a href="${task.url}" target="_blank">#${task.ticketNumber} ${escapeHtml(task.title)}</a>
            </div>
            <div class="task-actions">
              <button class="copy-btn" onclick="copyMarkdown('${task.ticketNumber}', '${escapeJs(task.title)}', '${task.url}', this)"><svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></button>
            </div>
          </div>
          <div class="task-meta">
            <span class="status-badge ${statusClass}">${escapeHtml(task.status)}</span>
            <span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ${escapeHtml(task.assignee)}</span>
            <span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg> ${escapeHtml(task.project)}</span>
            ${task.dueDate ? '<span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 14v2.2l1.6 1"/><path d="M16 2v4"/><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M3 10h5"/><path d="M8 2v4"/><circle cx="16" cy="16" r="6"/></svg> ' + task.dueDate + '</span>' : ''}
          </div>
          <div class="task-dates">
            ${created ? '<span>Created: ' + created + '</span>' : ''}
            ${updated ? '<span>Updated: ' + updated + '</span>' : ''}
          </div>
        </div>
      `;
    }

    function formatDate(iso) {
      if (!iso) return '';
      return new Date(iso).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function getStatusClass(status) {
      const s = status.toLowerCase();
      if (s.includes('done') || s.includes('complete') || s.includes('closed')) return 'status-done';
      if (s.includes('progress') || s.includes('review') || s.includes('testing')) return 'status-progress';
      return 'status-todo';
    }

    // SVG icons for JS use
    const checkIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
    const copyIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>';
    const xIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';

    function copyMarkdown(number, title, url, btn) {
      const markdown = '[#' + number + ' ' + title + '](' + url + ')';
      navigator.clipboard.writeText(markdown).then(() => {
        btn.innerHTML = checkIconSvg;
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = copyIconSvg;
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    async function updateNow() {
      const syncBtn = document.getElementById('syncBtn');
      const syncProgress = document.getElementById('syncProgress');
      const syncProgressText = document.getElementById('syncProgressText');
      const syncProgressBar = document.getElementById('syncProgressBar');
      
      // Show progress, hide button
      syncBtn.style.display = 'none';
      syncProgress.classList.add('active');
      syncProgressText.textContent = 'Connecting...';
      
      // Create progress segments (dynamic based on pages fetched)
      syncProgressBar.innerHTML = '';
      let segments = [];
      let lastPhase = '';
      
      // Use EventSource for real-time progress
      const eventSource = new EventSource('/update');
      
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'connecting') {
          syncProgressText.textContent = data.message;
        }
        
        if (data.type === 'progress') {
          // Add a new segment for each page fetched
          const segment = document.createElement('div');
          segment.className = 'sync-progress-segment filled';
          syncProgressBar.appendChild(segment);
          segments.push(segment);
          
          // Update text with current phase and page
          const phaseLabel = data.phase === 'subscribed' ? 'subscribed' : 'assigned';
          syncProgressText.textContent = `Fetching ${phaseLabel} (page ${data.page})...`;
          
          // Add pulsing indicator if more pages coming
          if (data.hasMore) {
            const pulse = syncProgressBar.querySelector('.pulse');
            if (!pulse) {
              const pulseEl = document.createElement('div');
              pulseEl.className = 'sync-progress-segment current pulse';
              syncProgressBar.appendChild(pulseEl);
            }
          } else {
            const pulse = syncProgressBar.querySelector('.pulse');
            if (pulse) pulse.remove();
          }
        }
        
        if (data.type === 'complete') {
          eventSource.close();
          // Remove any pulse indicator
          const pulse = syncProgressBar.querySelector('.pulse');
          if (pulse) pulse.remove();
          
          syncProgressText.innerHTML = checkIconSvg + ' Synced ' + data.taskCount + ' tasks';
          setTimeout(() => location.reload(), 1000);
        }
        
        if (data.type === 'error') {
          eventSource.close();
          syncProgressText.innerHTML = xIconSvg + ' ' + data.error;
          setTimeout(() => {
            syncProgress.classList.remove('active');
            syncBtn.style.display = '';
          }, 3000);
        }
      };
      
      eventSource.onerror = () => {
        eventSource.close();
        syncProgressText.innerHTML = xIconSvg + ' Connection error';
        setTimeout(() => {
          syncProgress.classList.remove('active');
          syncBtn.style.display = '';
        }, 3000);
      };
    }

    function updateCopyButtonState() {
      const btn = document.getElementById('copyAllBtn');
      const hasFilters = searchInput.value.trim() !== '' ||
                         filterProject.value !== '' ||
                         filterStatus.value !== '' ||
                         filterDue.value !== '' ||
                         filterMeOnly.checked;
      btn.disabled = !hasFilters;
      btn.title = hasFilters ? 'Copy filtered tasks as markdown' : 'Apply filters first';
    }

    async function copyAllAsMarkdown() {
      if (filteredTasks.length === 0) {
        alert('No tasks to copy');
        return;
      }

      // Group tasks by project
      const grouped = {};
      for (const task of filteredTasks) {
        if (!grouped[task.projectId]) {
          grouped[task.projectId] = {
            name: task.project,
            prefix: task.projectPrefix,
            tasks: []
          };
        }
        grouped[task.projectId].tasks.push(task);
      }

      // Build markdown output
      const firstTaskUrl = filteredTasks[0] ? filteredTasks[0].url : '';
      const urlParts = firstTaskUrl.split('app.productive.io/');
      const orgSlug = urlParts.length > 1 ? urlParts[1].split('/')[0] : '1476-dotcollective';
      
      let markdown = '';
      for (const projectId of Object.keys(grouped)) {
        const group = grouped[projectId];
        const projectUrl = 'https://app.productive.io/' + orgSlug + '/projects/' + projectId;
        markdown += '[' + group.name + '](' + projectUrl + ')\n';
        for (const task of group.tasks) {
          markdown += '- [ ] [#' + task.ticketNumber + ' ' + task.title + '](' + task.url + ')\n';
        }
        markdown += '\n';
      }

      try {
        await navigator.clipboard.writeText(markdown.trim());
        const btn = document.getElementById('copyAllBtn');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = checkIconSvg + ' Copied';
        btn.classList.add('copied');
        setTimeout(function() {
          btn.innerHTML = originalHtml;
          btn.classList.remove('copied');
        }, 2000);
      } catch (e) {
        alert('Failed to copy: ' + e.message);
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[c]));
    }

    function escapeJs(str) {
      if (!str) return '';
      return str.replace(/[\\\']/g, '\\$&').replace(/"/g, '\\"');
    }
  </script>
</body>
</html>
